<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.love.morec.attribute">

	<resultMap type="Attribute" id="attributeResult">
		<id property="id" column="id" />
		<result property="attr_number" column="attr_number" />
		<result property="attr_name" column="attr_name" />
		<result property="father_number" column="father_number"/>
		<result property="attr_value" column="attr_value" />
		<collection property="children" ofType="Attribute" resultMap="childrenAttributeResult"/>
	</resultMap>
	
	<resultMap type="Attribute" id="childrenAttributeResult">
		<id property="id" column="children_id" />
		<result property="attr_number" column="children_attr_number" />
		<result property="attr_name" column="children_attr_name" />
		<result property="father_number" column="children_father_number"/>
		<result property="attr_value" column="children_attr_value" />
	</resultMap>

	<sql id="queryAttr">
		select self.*,
			children.father_number as children_father_number,
			children.attr_number as children_attr_number,
			children.attr_name as children_attr_name,
			children.attr_value as children_attr_value
		 from cms_attributes  self
		 left join cms_attributes children on self.attr_number=children.father_number
		 
	</sql>
	
	<insert id="save" keyProperty="id" useGeneratedKeys="true">
		insert into cms_attributes(attr_number,attr_name,father_number,attr_value) values (#{attr_number},#{attr_name},#{father_number},#{attr_value})
	</insert>
	
	<update id="update" >
		update cms_attributes set id=#{id},attr_number=#{attr_number},attr_name=#{attr_name},father_number=#{father_number},attr_value=#{attr_value} where id=#{id}	
	</update>
	
	<delete id="deleteById">
		delete from cms_attributes where id=#{id}
	</delete>
	<select id="queryAttrs" parameterType="map" resultMap="attributeResult">
		select self.*
		from cms_attributes  self
		where self.attr_number=#{attr_number} and self.father_number=#{father_number}
	</select>
	<select id="queryTopAttr" parameterType="String" resultMap="attributeResult">
		select self.*,
			children.id as children_id,
			children.father_number as children_father_number,
			children.attr_number as children_attr_number,
			children.attr_name as children_attr_name,
			children.attr_value as children_attr_value
		 from cms_attributes  self
		 left join cms_attributes children on self.attr_number=children.father_number
		 where self.attr_number=#{attr_number}
	</select> 
	<select id="get" resultMap="attributeResult">
	<include refid="queryAttr"/>
		where self.id=#{id}
	</select>	
	<select id="queryPage" resultMap="attributeResult">
		<include refid="queryAttr" />
		order by self.id asc
	</select>
	
	<select id="queryPageByFather" parameterType="map" resultMap="attributeResult" >
		select * from cms_attributes where father_number=#{params.father}
	</select>
	
	<select id="queryPageByQ" parameterType="map" resultMap="attributeResult" >
		select * from cms_attributes where ${params.filed}=#{params.q}
	</select>
</mapper>