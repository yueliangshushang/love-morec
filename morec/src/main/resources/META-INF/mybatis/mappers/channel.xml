<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.love.morec.channel">
	<resultMap type="Channel" id="channelResult">
		<id property="id" column="id" />
		<result property="name" column="name" />
		<result property="path" column="path" />
		<result property="sort" column="sort" />
		<result property="tags" column="tags" />
		<result property="title" column="title" />
		<result property="hotKeyWord" column="hot_keyword" />
		<result property="metaKeyWord" column="meta_keyword" />
		<result property="metaDescr" column="meta_descr" />
		<result property="metaTitle" column="meta_title" />
		<result property="anchorText" column="anchor_text" />
		<result property="attributes" column="attributes" />
		<association property="father" column="father_id" javaType="Channel" resultMap="fatherChannelResult" />
		<collection property="template" ofType="Channel" javaType="Template" resultMap="templateResult" />
		<collection property="children" ofType="Channel" resultMap="childrenChannelResult" />
	</resultMap>

	<resultMap type="Template" id="templateResult">
		<id property="id" column="template_id" />
		<result property="name" column="name" />
		<result property="fileName" column="file_name" />
		<result property="content" column="content" />
		<result property="physicalUrl" column="physical_url" />
		<result property="sort" column="sort" />
		<result property="updateTime" column="update_time" jdbcType="TIMESTAMP" />
	</resultMap>
	<resultMap type="Channel" id="fatherChannelResult">
		<id property="id" column="father_id" />
		<result property="name" column="father_name" />
		<result property="path" column="father_path" />
		<result property="sort" column="father_sort" />
		<result property="tags" column="father_tags" />
		<result property="title" column="father_title" />
		<result property="hotKeyWord" column="father_hot_keyword" />
		<result property="metaKeyWord" column="father_meta_keyword" />
		<result property="metaTitle" column="father_meta_title" />
		<result property="metaDescr" column="father_meta_descr" />
		<result property="anchorText" column="father_anchor_text" />
		<result property="attributes" column="father_attributes" />
	</resultMap>
	<resultMap type="Channel" id="childrenChannelResult">
		<id property="id" column="child_id" />
		<result property="name" column="child_name" />
		<result property="path" column="child_path" />
		<result property="sort" column="child_sort" />
		<result property="tags" column="child_tags" />
		<result property="title" column="child_title" />
		<result property="hotKeyWord" column="child_hot_keyword" />
		<result property="metaTitle" column="child_meta_title" />
		<result property="metaKeyWord" column="child_meta_keyword" />
		<result property="metaDescr" column="child_meta_descr" />
		<result property="anchorText" column="child_anchor_text" />
		<result property="attributes" column="child_attributes" />
	</resultMap>

	<sql id="commonSelect">
		select
		self.id as id,
		self.name as name,
		self.path as path,
		self.sort as sort,
		self.tags as tags,
		father.id as father_id,
		father.name as father_name,
		father.path as father_path,
		father.sort as father_sort,
		father.tags as father_tags,
		father.title as father_title,
		father.hot_keyword as father_hot_keyword,
		father.meta_keyword as father_meta_keyword,
		father.meta_title as father_mata_title,
		father.meta_descr as father_meta_descr,
		father.anchor_text as father_anchor_text,
		father.attributes as father_attributes,
		children.id as child_id,
		children.name as child_name,
		children.path as child_path,
		children.sort as child_sort,
		children.tags as child_tags,
		children.title as child_title,
		children.hot_keyword as children_hot_keyword,
		children.meta_title as child_meta_title,
		children.meta_keyword as child_meta_keyword,
		children.meta_descr as child_meta_descr,
		children.anchor_text as children_anchor_text,
		children.attributes as child_attributes,
		template.*
		from cms_channel self
		left join cms_channel father on self.father_id=father.id
		left join cms_channel children on self.id=children.father_id
		left join cms_template template on self.template_id=template.id
	</sql>
	<sql id="commonShortSelect">
		select
		self.id,
		self.name,
		self.path
		from cms_channel self
	</sql>
	<insert id="save" keyProperty="id" useGeneratedKeys="true">
		insert into
		cms_channel(name,path,sort,tags,title,hot_keyword,meta_keyword,meta_descr,meta_title,father_id,template_id,anchor_text,attributes)
		values(#{name},#{path},#{sort},#{tags},#{title},#{hotKeyWord},#{metaKeyWord},#{metaDescr},#{metaTitle},#{father.id},#{template.id},#{anchorText},#{attributes})
	</insert>
	
	<update id="update">
		update cms_channel
		set name=#{name},path=#{path},sort=#{sort},tags=#{tags},title=#{title},
		hot_keyword=#{hotKeyWord},meta_keyword=#{metaKeyWord},meta_descr=#{metaDescr},
		father_id=#{father.id},meta_title=#{metaTitle},template_id=#{template.id},anchor_text=#{anchorText},attributes=#{attributes}}
		where id=#{id}

	</update>

	<delete id="delete">
		delete from cms_channel where id=#{id}
	</delete>

	<select id="delbefore" resultMap="channelResult">
		<include refid="commonSelect" />
		where children.id is not null and self.id=#{id}
	</select>
	
	<delete id="deleteById">
		delete from cms_channel where id=#{id}
	</delete>

	<select id="queryUniqueByPath" parameterType="string" resultMap="channelResult">
		<include refid="commonSelect" />
		where self.path=#{path}
	</select>
	
	<select id="queryUniqueByName" parameterType="string" resultMap="channelResult">
		<include refid="commonSelect" />
		where self.name=#{name}
	</select>
	
	<select id="get" resultMap="channelResult">
		<include refid="commonSelect" />
		where self.id=#{id}
	</select>
	
	<select id="query" resultMap="channelResult">
		<include refid="commonSelect" />
		order by self.sort asc
	</select>
	
	<select id="queryPage" resultMap="channelResult">
		<include refid="commonSelect" />
		order by self.sort asc
	</select>

	<select id="queryTop" resultMap="channelResult">
		select
		self.*,
		children.id as child_id,
		children.name as child_name,
		children.path as
		child_path,
		children.sort as child_sort,
		children.title as child_title,
		children.tags as child_tags,
		children.hot_keyword as child_hot_keyword,
		children.meta_title as child_mata_title,
		children.meta_keyword as
		child_meta_keyword,
		children.meta_descr as child_meta_descr,
		children.anchor_text as children_anchor_text,
		children.attributes as
		child_attributes
		from cms_channel self
		left join cms_channel children on self.id=children.father_id
		where self.father_id is null
		order by self.sort asc
	</select>

	<select id="queryPageTop" resultMap="channelResult">
		select self.*
		from cms_channel self
		where self.father_id is null
		order by self.sort asc
	</select>

	<select id="queryChildById" resultMap="channelResult">
		<include refid="commonSelect" />
		where self.father_id=#{id}
	</select>

	<select id="queryPageChildById" resultMap="channelResult">
		select self.*
		from cms_channel self
		where self.father_id=#{params.id}
		order by self.sort asc
	</select>

	<select id="queryChannels" resultMap="channelResult">
		<include refid="commonSelect" />
	</select>
	
	<select id="queryBrotherChannels" parameterType="string" resultMap="channelResult">
		<include refid="commonShortSelect" />
		<where>self.father_id=#{fatherId}</where>
		order by self.sort asc
	</select>
	
</mapper>